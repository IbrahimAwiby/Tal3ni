<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - User Management</title>
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: all 0.3s ease;
        border-left: 4px solid #4361ee;
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
      }

      .stat-card.total {
        border-left-color: #4361ee;
      }
      .stat-card.male {
        border-left-color: #4cc9f0;
      }
      .stat-card.female {
        border-left-color: #f72585;
      }
      .stat-card.recent {
        border-left-color: #7209b7;
      }

      .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 10px 0;
      }

      .stat-card.total .stat-number {
        color: #4361ee;
      }
      .stat-card.male .stat-number {
        color: #4cc9f0;
      }
      .stat-card.female .stat-number {
        color: #f72585;
      }
      .stat-card.recent .stat-number {
        color: #7209b7;
      }

      .chart-container {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        position: relative;
        height: 400px;
      }

      .chart-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      @media (max-width: 768px) {
        .chart-row {
          grid-template-columns: 1fr;
        }

        .chart-container {
          height: 350px;
        }
      }

      .recent-users {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-height: 500px;
        overflow-y: auto;
      }

      .user-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #eee;
        transition: background-color 0.3s ease;
      }

      .user-item:hover {
        background-color: #f8f9fa;
      }

      .user-item:last-child {
        border-bottom: none;
      }

      .user-info strong {
        color: #333;
        display: block;
        margin-bottom: 5px;
      }

      .user-meta {
        font-size: 0.9em;
        color: #666;
      }

      .nav-links {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .last-updated {
        text-align: center;
        color: #666;
        font-size: 0.9em;
        margin-top: 20px;
        padding: 10px;
        background: white;
        border-radius: 8px;
      }

      .loading-dashboard {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .loading-dashboard i {
        font-size: 2rem;
        margin-bottom: 15px;
      }

      .chart-wrapper {
        position: relative;
        height: 300px;
        width: 100%;
      }

      .no-data {
        text-align: center;
        color: #666;
        padding: 40px;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div id="toast-container"></div>

    <div class="container">
      <header>
        <div class="header-content">
          <i class="fas fa-chart-line"></i>
          <h1>Admin Dashboard</h1>
          <p>Real-time User Analytics & Insights</p>
        </div>
      </header>

      <div class="nav-links">
        <a href="/" class="btn-primary">
          <i class="fas fa-home"></i> Main App
        </a>
        <a href="/api-docs" class="btn-secondary">
          <i class="fas fa-code"></i> API Documentation
        </a>
        <button onclick="refreshDashboard()" class="btn-info">
          <i class="fas fa-sync-alt"></i> Refresh Data
        </button>
      </div>

      <div class="loading-dashboard" id="loadingDashboard">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Loading dashboard data...</p>
      </div>

      <div id="dashboardContent" style="display: none">
        <div class="dashboard-grid" id="statsGrid">
          <!-- Stats will be loaded here -->
        </div>

        <div class="chart-row">
          <div class="chart-container">
            <h2><i class="fas fa-chart-pie"></i> Users by Gender</h2>
            <div class="chart-wrapper">
              <canvas id="genderChart"></canvas>
            </div>
          </div>

          <div class="chart-container">
            <h2><i class="fas fa-car"></i> Popular Car Types</h2>
            <div class="chart-wrapper">
              <canvas id="carTypeChart"></canvas>
            </div>
          </div>
        </div>

        <div class="recent-users">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            "
          >
            <h2><i class="fas fa-clock"></i> Recent Users</h2>
            <span class="last-updated" id="lastUpdated"></span>
          </div>
          <div id="recentUsersList">
            <!-- Recent users will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <script>
      let genderChart, carTypeChart;
      let dashboardData = null;

      // Initialize dashboard
      document.addEventListener("DOMContentLoaded", function () {
        loadDashboard();
        // Refresh every 30 seconds
        setInterval(loadDashboard, 30000);
      });

      async function loadDashboard() {
        showLoading();
        try {
          const response = await fetch("/api/users/analytics/dashboard");

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          if (result.success) {
            dashboardData = result.data;
            updateStats(dashboardData);
            updateCharts(dashboardData);
            updateRecentUsers(dashboardData.recentUsers);
            updateLastUpdated();
            showDashboardContent();
          } else {
            throw new Error(result.message);
          }
        } catch (error) {
          console.error("Error loading dashboard:", error);
          showToast("Error", "Failed to load dashboard data", "error");
          showEmptyState();
        } finally {
          hideLoading();
        }
      }

      function refreshDashboard() {
        loadDashboard();
      }

      function showLoading() {
        document.getElementById("loadingDashboard").style.display = "block";
        document.getElementById("dashboardContent").style.display = "none";
      }

      function hideLoading() {
        document.getElementById("loadingDashboard").style.display = "none";
      }

      function showDashboardContent() {
        document.getElementById("dashboardContent").style.display = "block";
      }

      function showEmptyState() {
        const dashboardContent = document.getElementById("dashboardContent");
        dashboardContent.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: #666;">
                    <i class="fas fa-chart-bar" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.5;"></i>
                    <h3>No Data Available</h3>
                    <p>Start by adding users to see analytics and insights.</p>
                    <a href="/" class="btn-primary" style="margin-top: 20px;">
                        <i class="fas fa-plus"></i> Add Users
                    </a>
                </div>
            `;
        dashboardContent.style.display = "block";
      }

      function updateStats(data) {
        const statsGrid = document.getElementById("statsGrid");
        statsGrid.innerHTML = `
                <div class="stat-card total">
                    <i class="fas fa-users fa-2x"></i>
                    <div class="stat-number">${data.totalUsers}</div>
                    <p>Total Users</p>
                </div>
                <div class="stat-card male">
                    <i class="fas fa-male fa-2x"></i>
                    <div class="stat-number">${data.summary.male}</div>
                    <p>Male Users</p>
                </div>
                <div class="stat-card female">
                    <i class="fas fa-female fa-2x"></i>
                    <div class="stat-number">${data.summary.female}</div>
                    <p>Female Users</p>
                </div>
                <div class="stat-card recent">
                    <i class="fas fa-user-plus fa-2x"></i>
                    <div class="stat-number">${data.recentRegistrations}</div>
                    <p>New This Week</p>
                </div>
            `;
      }

      function updateCharts(data) {
        // Gender Chart - Pie Chart
        const genderCtx = document
          .getElementById("genderChart")
          .getContext("2d");
        if (genderChart) genderChart.destroy();

        if (data.usersByGender && data.usersByGender.length > 0) {
          genderChart = new Chart(genderCtx, {
            type: "doughnut",
            data: {
              labels: data.usersByGender.map(
                (g) => g._id.charAt(0).toUpperCase() + g._id.slice(1)
              ),
              datasets: [
                {
                  data: data.usersByGender.map((g) => g.count),
                  backgroundColor: [
                    "#4cc9f0",
                    "#f72585",
                    "#7209b7",
                    "#4361ee",
                    "#f8961e",
                  ],
                  borderWidth: 2,
                  borderColor: "#fff",
                  hoverOffset: 8,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "bottom",
                  labels: {
                    padding: 20,
                    usePointStyle: true,
                    font: {
                      size: 12,
                    },
                  },
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      const label = context.label || "";
                      const value = context.raw || 0;
                      const total = context.dataset.data.reduce(
                        (a, b) => a + b,
                        0
                      );
                      const percentage = Math.round((value / total) * 100);
                      return `${label}: ${value} (${percentage}%)`;
                    },
                  },
                },
              },
              cutout: "50%",
            },
          });
        } else {
          document.getElementById("genderChart").parentElement.innerHTML =
            '<div class="no-data">No gender data available</div>';
        }

        // Car Type Chart - Bar Chart
        const carTypeCtx = document
          .getElementById("carTypeChart")
          .getContext("2d");
        if (carTypeChart) carTypeChart.destroy();

        if (data.popularCarTypes && data.popularCarTypes.length > 0) {
          // Sort car types by count for better visualization
          const sortedCarTypes = [...data.popularCarTypes]
            .sort((a, b) => b.count - a.count)
            .slice(0, 8); // Limit to top 8 for better readability

          carTypeChart = new Chart(carTypeCtx, {
            type: "bar",
            data: {
              labels: sortedCarTypes.map((c) =>
                c._id.length > 15 ? c._id.substring(0, 15) + "..." : c._id
              ),
              datasets: [
                {
                  label: "Number of Users",
                  data: sortedCarTypes.map((c) => c.count),
                  backgroundColor: "#4361ee",
                  borderWidth: 0,
                  borderRadius: 4,
                  borderSkipped: false,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  grid: {
                    display: true,
                  },
                  ticks: {
                    stepSize: 1,
                  },
                },
                x: {
                  grid: {
                    display: false,
                  },
                  ticks: {
                    maxRotation: 45,
                    minRotation: 45,
                  },
                },
              },
              plugins: {
                legend: {
                  display: false,
                },
                tooltip: {
                  callbacks: {
                    title: function (tooltipItems) {
                      const index = tooltipItems[0].dataIndex;
                      return sortedCarTypes[index]._id;
                    },
                  },
                },
              },
            },
          });
        } else {
          document.getElementById("carTypeChart").parentElement.innerHTML =
            '<div class="no-data">No car type data available</div>';
        }
      }

      function updateRecentUsers(users) {
        const recentUsersList = document.getElementById("recentUsersList");

        if (users.length === 0) {
          recentUsersList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>No users yet</p>
                    </div>
                `;
          return;
        }

        recentUsersList.innerHTML = users
          .map(
            (user) => `
                <div class="user-item">
                    <div class="user-info">
                        <strong>${escapeHtml(user.username)}</strong>
                        <div class="user-meta">
                            <i class="fas fa-phone"></i> ${escapeHtml(
                              user.phoneNumber
                            )} â€¢ 
                            <i class="fas fa-car"></i> ${escapeHtml(
                              user.carType
                            )} (${escapeHtml(user.carNumber)})
                        </div>
                    </div>
                    <div style="font-size: 0.8em; color: #999; text-align: right;">
                        <div>${new Date(
                          user.createdAt
                        ).toLocaleDateString()}</div>
                        <div>${new Date(
                          user.createdAt
                        ).toLocaleTimeString()}</div>
                    </div>
                </div>
            `
          )
          .join("");
      }

      function updateLastUpdated() {
        const lastUpdatedElement = document.getElementById("lastUpdated");
        const now = new Date();
        lastUpdatedElement.textContent = `Last updated: ${now.toLocaleTimeString()}`;
      }

      function showToast(title, message, type = "info") {
        const toastContainer = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;

        const icons = {
          success: "fas fa-check-circle",
          error: "fas fa-exclamation-circle",
          warning: "fas fa-exclamation-triangle",
          info: "fas fa-info-circle",
        };

        toast.innerHTML = `
                <i class="${icons[type]}"></i>
                <div class="toast-content">
                    <h4>${escapeHtml(title)}</h4>
                    <p>${escapeHtml(message)}</p>
                </div>
            `;

        toastContainer.appendChild(toast);

        setTimeout(() => toast.classList.add("show"), 100);

        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 300);
        }, 5000);
      }

      function escapeHtml(unsafe) {
        if (typeof unsafe !== "string") return unsafe;
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // Handle window resize
      window.addEventListener("resize", function () {
        if (genderChart) {
          genderChart.resize();
        }
        if (carTypeChart) {
          carTypeChart.resize();
        }
      });
    </script>
  </body>
</html>
